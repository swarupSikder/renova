{% extends "events/dashboard.html" %}
{% load static %}
{% block title %}Users Control{% endblock %}
{% block content %}

<h1 class="text-4xl font-extrabold mb-8 text-gray-900">Users Management</h1>

<div class="overflow-x-auto rounded-lg shadow border border-gray-300">
  <table class="min-w-full divide-y divide-gray-200">
    <thead class="bg-gray-50">
      <tr>
        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
          Username
        </th>
        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
          Email
        </th>
        <th scope="col" class="px-6 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">
          Active
        </th>
        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
          Role
        </th>
        <th scope="col" class="px-6 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">
          Actions
        </th>
      </tr>
    </thead>
    <tbody class="bg-white divide-y divide-gray-200">
      {% for user in users %}
      <tr class="hover:bg-gray-50 transition duration-150">
        <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">
          {{ user.username }}
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-gray-700">
          {{ user.email }}
        </td>

        <!-- Active Checkbox -->
        <td class="px-6 py-4 whitespace-nowrap text-center">
          <form method="post" id="active-form-{{ user.id }}">
            {% csrf_token %}
            <input type="hidden" name="user_id" value="{{ user.id }}">
            <input type="hidden" name="action" value="toggle_active">
            <label class="inline-flex items-center cursor-pointer space-x-2 select-none">
              <input 
                type="checkbox" 
                name="is_active" 
                {% if user.is_active %}checked{% endif %}
                onchange="document.getElementById('active-form-{{ user.id }}').submit()"
                class="form-checkbox h-5 w-5 text-indigo-600"
              >
              <span class="text-gray-700 font-semibold">Active</span>
            </label>
          </form>
        </td>

        <!-- Role -->
        <td class="px-6 py-4 whitespace-nowrap text-gray-800">
          {% if user.groups.all %}
            {{ user.groups.all.0.name }}
          {% else %}
            <span class="italic text-gray-400">Participant</span>
          {% endif %}
        </td>

        <!-- Actions -->
        <td class="px-6 py-4 whitespace-nowrap text-center space-x-2 flex justify-center items-center">
          <!-- Change Role Dropdown -->
          <form method="post" class="inline-block">
            {% csrf_token %}
            <input type="hidden" name="user_id" value="{{ user.id }}">
            <input type="hidden" name="action" value="change_role">
            <select name="new_role" class="border border-gray-300 rounded bg-white px-3 py-1 text-sm text-gray-700 hover:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-400" onchange="this.form.submit()">
              <option value="">Change Role</option>
              {% for group in groups %}
                <option value="{{ group }}" {% if user.groups.all.first.name == group %}selected{% endif %}>{{ group }}</option>
              {% endfor %}
            </select>
          </form>

          <!-- Delete Button -->
          <form method="post" class="inline-block" onsubmit="return confirm('Are you sure you want to delete this user?');">
            {% csrf_token %}
            <input type="hidden" name="user_id" value="{{ user.id }}">
            <button name="action" value="delete" type="submit"
              class="bg-red-600 hover:bg-red-700 text-white font-semibold px-4 py-1 rounded transition duration-150">
              Delete
            </button>
          </form>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="5" class="text-center p-6 text-gray-500">No users found.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% endblock %}